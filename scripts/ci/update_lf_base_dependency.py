#!/usr/bin/env python

import re
import sys
from pathlib import Path

import packaging.version

BASE_DIR = Path(__file__).parent.parent.parent
ARGUMENT_NUMBER = 3


def update_base_dep(pyproject_path: str, new_version: str) -> None:
    """Update the primeagent-base dependency in pyproject.toml."""
    filepath = BASE_DIR / pyproject_path
    content = filepath.read_text(encoding="utf-8")

    # Updated pattern to handle PEP 440 version suffixes, extras (e.g., [complete]),
    # both ~= and == version specifiers, and both primeagent-base and primeagent-base-nightly names
    # Captures extras in group 2 to preserve them in the replacement
    pattern = re.compile(
        r'("primeagent-base(?:-nightly)?((?:\[[^\]]+\])?)(?:~=|==)[\d.]+(?:\.(?:post|dev|a|b|rc)\d+)*")'
    )

    # Check if the pattern is found
    match = pattern.search(content)
    if not match:
        msg = f'primeagent-base dependency not found in "{filepath}"'
        raise ValueError(msg)

    # Extract extras if present (e.g., "[complete]")
    extras = match.group(2) if match.group(2) else ""
    replacement = f'"primeagent-base-nightly{extras}=={new_version}"'

    # Replace the matched pattern with the new one
    content = pattern.sub(replacement, content)
    filepath.write_text(content, encoding="utf-8")


def update_wfx_dep_in_base(pyproject_path: str, wfx_version: str) -> None:
    """Update the WFX dependency in primeagent-base pyproject.toml to use nightly version."""
    filepath = BASE_DIR / pyproject_path
    content = filepath.read_text(encoding="utf-8")

    # Updated pattern to handle PEP 440 version suffixes, both ~= and == version specifiers,
    # and both wfx and wfx-nightly names
    pattern = re.compile(r'("wfx(?:-nightly)?(?:~=|==)[\d.]+(?:\.(?:post|dev|a|b|rc)\d+)*")')
    replacement = f'"wfx-nightly=={wfx_version}"'

    # Check if the pattern is found
    if not pattern.search(content):
        msg = f'WFX dependency not found in "{filepath}"'
        raise ValueError(msg)

    # Replace the matched pattern with the new one
    content = pattern.sub(replacement, content)
    filepath.write_text(content, encoding="utf-8")


def verify_pep440(version):
    """Verify if version is PEP440 compliant.

    https://github.com/pypa/packaging/blob/16.7/packaging/version.py#L191
    """
    return packaging.version.Version(version)


def main() -> None:
    if len(sys.argv) != ARGUMENT_NUMBER:
        msg = "Usage: update_lf_base_dependency.py <base_version> <wfx_version>"
        raise ValueError(msg)
    base_version = sys.argv[1]
    wfx_version = sys.argv[2]

    # Strip "v" prefix from versions if present
    base_version = base_version.removeprefix("v")
    wfx_version = wfx_version.removeprefix("v")

    verify_pep440(base_version)
    verify_pep440(wfx_version)

    # Update primeagent-base dependency in main project
    update_base_dep("pyproject.toml", base_version)

    # Update WFX dependency in primeagent-base
    update_wfx_dep_in_base("src/backend/base/pyproject.toml", wfx_version)


if __name__ == "__main__":
    main()
